# 从RFC3489的演进

## STUN最开始是在RFC3489中定义的，RFC3489通常称之为“经典STUN”，这意味着它是一个完整的NAT穿透的解决方案。在RFC3489这个解决方案里，客户端可以发现自身是否在NAT之后，发现自己的NAT类型，发现自身在公网侧映射的IP和端口，随后客户端可以在类似SIP[RFC3261]等协议体中利用前述中发现的IP和端口。然而，在实践中发现经典STUN作为一个可部署的解决方案不够有效，从经典STUN中获取的IP地址和端口有时候是可用的有时候又是不可用的。事实上，经典STUN并没有提供检查自己是否起效的方法，也没有在不起效的地方提供纠错的手段。而且，经典STUN提供的NAT分类的方法是错误的，很多NAT并没有办法完美地匹配到它定义地类型中。

## 在安全方面，经典STUN也是有缺陷地。在一些网络拓扑和限制下，攻击者可以给客户端提供错误地映射地址，并且这种攻击方式基本上是没办法通过加密的方式来解决。虽然在这篇指南里提供的STUN工具仍然不能解决这个问题，但是像ICE一样的利用STUN工具的更完整的解决方案能够有效缓解。

## 基于以上的原因，这篇指南淘汰掉了RFC3489，把STUN提出作为一个完整的NAT穿透解决方案的工具。ICE是一个基于提供/应答[RFC3264]模型的完整的解决方案。SIP-Outbound是一个SIP信令穿透的解决方案，它使用了一个STUN的不同的用法。虽然一个协议可以就使用STUN来完成NAT穿透（就像经典STUN），这边指南中将不会再提及此类方案，同时由于以上的原因，这些方案也不推荐使用。

## 下文描述的协议从经典STUN里做了轻微的更改，现在STUN传输层既可以使用UDP也可以用使用TCP。相比以前，STUN能够进行更有结构化地扩展。添加了一个32位地Magic Cookie用于区分STUN和其他地应用层协议，这个32位的magic cookie是从经典STUN的128位事务ID中拿走掉32位组成的，这样可以做到向下兼容。映射地址采用了异或的方法编码，更多的改动可以在19章中查看。

## 由于这些改动，STUN从 Simple Traversel of UDP through NAT （NAT的UDP简单穿透）更名为 Session Traversal Utilities for NAT（NAT会话穿透程序），简称任然是众所周知的STUN。